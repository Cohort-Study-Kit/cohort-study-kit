{% extends "admin/base_site.html" %}
{% load i18n l10n admin_urls static %}

{% block title %}Merge Visits{% endblock %}

{% block extrahead %}
    {{ block.super }}
    {{ form.media }}
    <style>
        .visit-option {
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .visit-option:hover {
            background-color: #f0f0f0;
        }
        .visit-details {
            margin-top: 10px;
            padding-left: 20px;
            color: #555;
            font-size: 0.9em;
        }
        .visit-option label strong {
            color: #333;
        }
        .visit-details div {
            margin: 3px 0;
        }
        /* Style for the main visit title */
        .visit-option > label > strong:first-child {
            color: #000;
            font-weight: bold;
        }
        .form-row {
            margin-bottom: 10px;
        }
        input[type="radio"] {
            margin-right: 10px;
        }
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .visit-option {
                background-color: #2d2d2d;
                border-color: #555;
            }
            .visit-option:hover {
                background-color: #3d3d3d;
            }
            .visit-details {
                color: #ccc;
            }
            .visit-option label {
                color: #fff;
            }
            .visit-option label strong {
                color: #fff;
            }
            /* Ensure the visit title is visible */
            .visit-option > label > strong:first-child {
                color: #fff !important;
                font-weight: bold;
            }
        }
    </style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; <a href="{% url 'admin:data_visit_changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
&rsaquo; {% trans 'Merge Visits' %}
</div>
{% endblock %}

{% block content %}
<div class="module">
    <h1>Merge Visits</h1>

    <p>Select which visit should be kept. All examinations from the other visits will be moved to the selected visit, and the other visits will be marked as deleted.</p>

    <form method="post" action="{% url 'admin:data_visit_merge' %}">
        {% csrf_token %}

        {% for hidden in form.hidden_fields %}
            {{ hidden }}

        {% endfor %}

        {% if form.non_field_errors %}
            <div class="errornote">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <div class="form-row">
            <h2>Selected Visits</h2>
            {% if form.keep_visit.errors %}
                <ul class="errorlist">
                    {% for error in form.keep_visit.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}

            <div>
                {% for visit in visits %}
                <div class="visit-option">
                    <label>
                        <input type="radio" name="{{ form.keep_visit.html_name }}" value="{{ visit.pk }}" {% if form.keep_visit.value == visit.pk|unlocalize %}checked{% endif %}>
                        <strong>{{ visit }}</strong>
                        <div class="visit-details">
                            <div><strong>Visit Type:</strong> {{ visit.fk_visit_type }}</div>
                            <div><strong>Status:</strong> {{ visit.get_status_display }}</div>
                            <div><strong>Visit Date:</strong> {{ visit.visit_date|date:"Y-m-d"|default:"Not set" }}</div>
                            <div><strong>Examinations:</strong> {{ visit.examination_set.count }}</div>
                            <div><strong>ID:</strong> {{ visit.pk }}</div>
                        </div>
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="submit-row">
            <input type="submit" value="Merge Visits" class="default">
            <a href="{% url 'admin:data_visit_changelist' %}" class="button cancel-link">Cancel</a>
        </div>
    </form>

</div>
{% endblock %}
